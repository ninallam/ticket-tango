name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      location:
        description: 'Azure region'
        required: true
        default: 'East US'
        type: string
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      location:
        required: true
        type: string
  push:
    branches:
      - main
    paths:
      - 'infrastructure/**'

env:
  AZURE_RESOURCE_GROUP: 'tickettango-rg'

permissions:
  id-token: write
  contents: read

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'dev' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Set environment variables
      shell: pwsh
      run: |
        "ENVIRONMENT=${{ inputs.environment || 'dev' }}" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding UTF8
        "LOCATION=${{ inputs.location || 'East US' }}" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding UTF8
        $deploymentName = "tickettango-deployment-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
        "DEPLOYMENT_NAME=$deploymentName" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding UTF8

    - name: Run Azure CLI deployment
      env:
        SQL_ADMIN_LOGIN: ${{ secrets.SQL_ADMIN_LOGIN }}
        SQL_ADMIN_PASSWORD: ${{ secrets.SQL_ADMIN_PASSWORD }}
      shell: bash
      run: |
        set -euo pipefail
        cd infrastructure

        # ensure resource group exists
        az group create --name "$AZURE_RESOURCE_GROUP" --location "$LOCATION" --output none || true

        # deploy Bicep template and capture properties directly to file
        az deployment group create \
          --resource-group "$AZURE_RESOURCE_GROUP" \
          --name "$DEPLOYMENT_NAME" \
          --template-file main.bicep \
          --parameters namePrefix=tickettango environment="$ENVIRONMENT" location="$LOCATION" sqlAdminLogin="$SQL_ADMIN_LOGIN" sqlAdminPassword="$SQL_ADMIN_PASSWORD" clientUrl="" \
          --query properties --output json > deployment-output.json

    - name: Get deployment outputs
      id: outputs
      shell: pwsh
      run: |
        cd infrastructure
        $deploymentJson = Get-Content "deployment-output.json" | ConvertFrom-Json
        $webAppUrl = $deploymentJson.Properties.Outputs.webAppUrl.Value
        $webAppName = $deploymentJson.Properties.Outputs.webAppName.Value
        $sqlServerName = $deploymentJson.Properties.Outputs.sqlServerName.Value
        
        "web-app-url=$webAppUrl" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding UTF8
        "web-app-name=$webAppName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding UTF8
        "sql-server-name=$sqlServerName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding UTF8
        
        "### Deployment Summary ðŸ“‹" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding UTF8
        "- **Web App URL**: $webAppUrl" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding UTF8
        "- **Web App Name**: $webAppName" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding UTF8
        "- **SQL Server**: $sqlServerName" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding UTF8
        "- **Resource Group**: ${{ env.AZURE_RESOURCE_GROUP }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding UTF8
        "- **Environment**: ${{ env.ENVIRONMENT }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding UTF8

    outputs:
      web-app-url: ${{ steps.outputs.outputs.web-app-url }}
      web-app-name: ${{ steps.outputs.outputs.web-app-name }}
      sql-server-name: ${{ steps.outputs.outputs.sql-server-name }}