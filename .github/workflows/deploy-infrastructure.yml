name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      location:
        description: 'Azure region'
        required: true
        default: 'East US'
        type: string
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      location:
        required: true
        type: string
  push:
    branches:
      - main
    paths:
      - 'infrastructure/**'

env:
  AZURE_RESOURCE_GROUP: 'tickettango-rg'

permissions:
  id-token: write
  contents: read

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'dev' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Set environment variables
      shell: pwsh
      run: |
        "ENVIRONMENT=${{ inputs.environment || 'dev' }}" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding UTF8
        "LOCATION=${{ inputs.location || 'East US' }}" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding UTF8
        $deploymentName = "tickettango-deployment-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
        "DEPLOYMENT_NAME=$deploymentName" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding UTF8

    - name: Create Resource Group
      shell: pwsh
      run: |
        New-AzResourceGroup `
          -Name "${{ env.AZURE_RESOURCE_GROUP }}" `
          -Location "${{ env.LOCATION }}" `
          -Force

    - name: Deploy Bicep template
      id: deploy
      shell: pwsh
      run: |
        cd infrastructure
        $deploymentResult = New-AzResourceGroupDeployment `
          -ResourceGroupName "${{ env.AZURE_RESOURCE_GROUP }}" `
          -Name "${{ env.DEPLOYMENT_NAME }}" `
          -TemplateFile "main.bicep" `
          -namePrefix "tickettango" `
          -environment "${{ env.ENVIRONMENT }}" `
          -location "${{ env.LOCATION }}" `
          -sqlAdminLogin "${{ secrets.SQL_ADMIN_LOGIN }}" `
          -sqlAdminPassword (ConvertTo-SecureString "${{ secrets.SQL_ADMIN_PASSWORD }}" -AsPlainText -Force) `
          -clientUrl ""
        
        # Convert deployment result to JSON and save to file
        $deploymentResult | ConvertTo-Json -Depth 10 | Out-File -FilePath "deployment-output.json" -Encoding UTF8

    - name: Get deployment outputs
      id: outputs
      shell: pwsh
      run: |
        cd infrastructure
        $deploymentJson = Get-Content "deployment-output.json" | ConvertFrom-Json
        $webAppUrl = $deploymentJson.Properties.Outputs.webAppUrl.Value
        $webAppName = $deploymentJson.Properties.Outputs.webAppName.Value
        $sqlServerName = $deploymentJson.Properties.Outputs.sqlServerName.Value
        
        "web-app-url=$webAppUrl" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding UTF8
        "web-app-name=$webAppName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding UTF8
        "sql-server-name=$sqlServerName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding UTF8
        
        "### Deployment Summary ðŸ“‹" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding UTF8
        "- **Web App URL**: $webAppUrl" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding UTF8
        "- **Web App Name**: $webAppName" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding UTF8
        "- **SQL Server**: $sqlServerName" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding UTF8
        "- **Resource Group**: ${{ env.AZURE_RESOURCE_GROUP }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding UTF8
        "- **Environment**: ${{ env.ENVIRONMENT }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding UTF8

    outputs:
      web-app-url: ${{ steps.outputs.outputs.web-app-url }}
      web-app-name: ${{ steps.outputs.outputs.web-app-name }}
      sql-server-name: ${{ steps.outputs.outputs.sql-server-name }}